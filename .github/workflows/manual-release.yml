# .github/workflows/manual-release.yml

###################
# ENV VARS:
# - PAT (generated at Personal Access Tokens - with workflow access checked)
###################

name: Create new release manually

on:
  workflow_dispatch:
    inputs:
      version:
        description: "N8N version (leave empty to use latest)"
        required: false
        type: string
      use_latest:
        description: "Use latest N8N version"
        required: false
        default: true
        type: boolean

jobs:
  get-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest stable N8N version from GitHub API
        id: get-latest
        run: |
          # Fetch all releases and filter for stable versions only (not pre-release)
          LATEST_VERSION=$(curl -s https://api.github.com/repos/n8n-io/n8n/releases | \
            jq -r '.[] | select(.prerelease == false) | .tag_name' | \
            head -1 | \
            sed 's/^n8n@//')

          if [ -z "$LATEST_VERSION" ]; then
            echo "Error: Could not fetch latest stable version"
            exit 1
          fi

          echo "latest_version=${LATEST_VERSION}" >> $GITHUB_OUTPUT
          echo "Latest stable N8N version: ${LATEST_VERSION}"

      - name: Determine version to use
        id: determine-version
        run: |
          if [[ "${{ github.event.inputs.use_latest }}" == "true" || -z "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ steps.get-latest.outputs.latest_version }}"
            echo "Using latest version: ${VERSION}"
          else
            VERSION="${{ github.event.inputs.version }}"
            echo "Using manual version: ${VERSION}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "${VERSION}" > release-versions/n8n-latest.txt

      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "New release ${{ steps.determine-version.outputs.version }}"
